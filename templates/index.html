{% extends "base.html" %}

{% block title %}Ad-Lib Game AI Generated :3 {% endblock %}

{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<h1>Ad-Lib Game with ChatGPT</h1>

<!-- Add this near the top of your body -->
<div class="loading-screen" style="display: none;">
    <div class="loading-content">
        <img src="{{ url_for('static', filename='loading.gif') }}" alt="Loading...">
        <p>Generating your story...</p>
    </div>
</div>

{% if 'user' not in session %}
    {% if session.get('usage_count', 0) < 3 %}
        <p>You have {{ 3 - session.get('usage_count', 0) }} free tries remaining. Sign in for unlimited use.</p>
    {% else %}
        <p>You have used all your free tries. Please <a href="{{ url_for('login') }}">sign in</a> to continue.</p>
    {% endif %}
{% endif %}

{% if error %}
    <p class="error">{{ error }}</p>
{% endif %}

<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<form action="{{ url_for('submit') }}" method="post" id="submit-form">
    <label for="artstyle">Image Art Style:</label>
    <select id="artstyle" name="artstyle">
        <option value="abstract">Abstract</option>
        <option value="realism">Realism</option>
        <option value="impressionism">Impressionism</option>
        <option value="cubism">Cubism</option>
        <option value="Cartoon">Cartoon</option>
        <option value="Gothic">Gothic</option>
        <option value="StickFigure">Stick Figure</option>
        <!-- Add more options as needed -->
    </select><br>

    <label for="noun">Noun:</label>
    <input type="text" id="noun" name="noun" required><br>

    <label for="verb">Verb:</label>
    <input type="text" id="verb" name="verb" required><br>

    <label for="adjective">Adjective:</label>
    <input type="text" id="adjective" name="adjective" required><br>

    <label for="adverb">Adverb:</label>
    <input type="text" id="adverb" name="adverb" required><br>

    <label for="number">Number:</label>
    <input type="number" id="number" name="number" required><br>

    <label for="bodypart">Body Part:</label>
    <input type="text" id="bodypart" name="bodypart" required><br>
    
    <div class="g-recaptcha" data-sitekey="{{ config['RECAPTCHA_SITE_KEY'] }}"></div>
    
    <button type="submit" class="btn-submit">Submit</button>
</form>

<div id="result" style="display: none;">
    <h2>Your Ad-Lib Story:</h2>
    <p id="story"></p>
    <img id="image" src="" alt="DALL-E Image">
</div>


{% if story %}
    <h2>Your Ad-Lib Story:</h2>
    <p>{{ story }}</p>
{% endif %}

{% if image %}
    <img src="{{ image }}" alt="DALL-E Image">
{% endif %}

<form action="/create-checkout-session" method="POST">
    <button type="submit" id="checkout-button">Checkout</button>
</form>

<script src="https://js.stripe.com/v3/"></script>
<script>
    var stripe = Stripe('{{ config["STRIPE_PUBLISHABLE_KEY"] }}');
    var checkoutButton = document.getElementById('checkout-button');

    checkoutButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        checkoutButton.disabled = true;
        checkoutButton.textContent = 'Processing...';

        fetch('/create-checkout-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(function(session) {
            return stripe.redirectToCheckout({ sessionId: session.id });
        })
        .then(function(result) {
            if (result.error) {
                alert(result.error.message);
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            alert('There was a problem with your payment. Please try again.');
        })
        .finally(function() {
            checkoutButton.disabled = false;
            checkoutButton.textContent = 'Checkout';
        });
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('submit-form');
    const loadingScreen = document.querySelector('.loading-screen');
    const resultDiv = document.getElementById('result');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // First check reCAPTCHA
        const recaptchaResponse = grecaptcha.getResponse();
        console.log('reCAPTCHA response:', recaptchaResponse);
        
        if (!recaptchaResponse) {
            alert('Please complete the CAPTCHA');
            return;
        }

        // Show loading screen only after CAPTCHA is verified
        loadingScreen.style.display = 'flex';
        resultDiv.style.display = 'none';

        let formData = new FormData(form);
        formData.append('g-recaptcha-response', recaptchaResponse);
        
        // Log the FormData contents (for debugging)
        for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }

        fetch('{{ url_for("submit") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || 'Something went wrong');
                });
            }
            return response.json();
        })
        .then(data => {
            loadingScreen.style.display = 'none';
            
            if (data.error) {
                if (data.require_payment) {
                    if (confirm('Your free trial has expired. Would you like to purchase unlimited access?')) {
                        document.getElementById('checkout-button').click();
                    }
                } else if (data.require_login) {
                    if (confirm('You've reached the maximum free uses. Would you like to sign in?')) {
                        window.location.href = '{{ url_for("login") }}';
                    }
                } else {
                    alert(data.error);
                }
            } else {
                document.querySelector('#story').textContent = data.story;
                document.querySelector('#image').src = data.image;
                resultDiv.style.display = 'block';
            }
        })
        .catch(error => {
            loadingScreen.style.display = 'none';
            console.error('Error:', error);
            alert(error.message || 'An error occurred. Please try again.');
        })
        .finally(() => {
            grecaptcha.reset();
        });
    });
});
</script>



{% endblock %}
