{% extends "base.html" %}

{% block title %}Ad-Lib Game AI Generated{% endblock %}

{% block content %}
<div class="main-container">
    <div class="header-section">
        <h1>(M)Ad-Lib Game</h1>
        <div class="auth-buttons">
            {% if user_info %}
                <span class="welcome-message">Welcome, {{ user_info.name }}!</span>
                <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
            {% else %}
                <a href="{{ url_for('login') }}" class="btn-login">Login</a>
                <a href="{{ url_for('register') }}" class="btn-register">Register</a>
            {% endif %}
        </div>
    </div>

    <div class="credits-info">
        {% if user_info %}
            {% if credits > 0 %}
                <p class="status-message">You have {{ credits }} credits remaining</p>
            {% endif %}
            {% if free_tries > 0 %}
                <p class="status-message">You have {{ free_tries }} free tries remaining</p>
            {% endif %}
            {% if credits == 0 and free_tries == 0 %}
                <p class="status-message">You don't have any credits or free tries. Purchase some to continue!</p>
            {% endif %}
        {% else %}
            {% if free_tries > 0 %}
                <p class="status-message">You have {{ free_tries }} free tries remaining. 
                    <a href="{{ url_for('login') }}">Sign in</a> for more!
                </p>
            {% else %}
                <p class="status-message">You've used all free tries. 
                    <a href="{{ url_for('login') }}">Sign in</a> to continue!
                </p>
            {% endif %}
        {% endif %}
    </div>

    <div class="game-section">
        <div class="form-container">
            <h2>Create Your Story</h2>
            <form action="{{ url_for('submit') }}" method="post" id="submit-form">
                <!--{{ csrf_token() }}-->
                <div class="form-grid">
                    <div class="form-group">
                        <label for="artstyle">Art Style</label>
                        <select id="artstyle" name="artstyle" class="form-control">
                            <option value="abstract">Abstract</option>
                            <option value="realism">Realism</option>
                            <option value="impressionism">Impressionism</option>
                            <option value="cubism">Cubism</option>
                            <option value="Cartoon">Cartoon</option>
                            <option value="Gothic">Gothic</option>
                            <option value="StickFigure">Stick Figure</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="noun">Noun</label>
                        <input type="text" id="noun" name="noun" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="verb">Verb</label>
                        <input type="text" id="verb" name="verb" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="adjective">Adjective</label>
                        <input type="text" id="adjective" name="adjective" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="adverb">Adverb</label>
                        <input type="text" id="adverb" name="adverb" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="number">Number</label>
                        <input type="number" id="number" name="number" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="bodypart">Body Part</label>
                        <input type="text" id="bodypart" name="bodypart" class="form-control" required>
                    </div>
                </div>
                
                <div class="recaptcha-container">
                    <div class="g-recaptcha" data-sitekey="{{ config['RECAPTCHA_SITE_KEY'] }}"></div>
                </div>
                
                <button type="submit" class="btn-submit">Generate Story</button>
            </form>
        </div>

        {% if user_info %}
        <div class="purchase-credits">
            <h2>Purchase Credits</h2>
            <div class="credit-options">
                <button onclick="purchaseCredits(1)" class="credit-option">1 Credit - $1</button>
                <button onclick="purchaseCredits(5)" class="credit-option">5 Credits - $5</button>
                <button onclick="purchaseCredits(10)" class="credit-option">10 Credits - $10</button>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="loading-screen" style="display: none;">
        <div class="loading-content">
            <img src="{{ url_for('static', filename='/images/loading.gif') }}" alt="Loading...">
            <p>Generating your story...</p>
        </div>
    </div>

    <div id="result" class="result-container" style="display: none;">
        <h2>Your Ad-Lib Story</h2>
        <div class="story-content">
            <p id="story"></p>
            <img id="image" src="" alt="DALL-E Image">
        </div>
    </div>
</div>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<script src="https://js.stripe.com/v3/"></script>
<!-- <script src="{{ url_for('static', filename='js/index.js') }}"></script> -->

<script>
    const stripe = Stripe('{{ config["STRIPE_PUBLISHABLE_KEY"] }}');
    
    async function purchaseCredits(credits) {
        try {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Processing...';

            const response = await fetch('/create-checkout-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ credits: credits })
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const session = await response.json();
            
            const result = await stripe.redirectToCheckout({
                sessionId: session.id
            });

            if (result.error) {
                throw new Error(result.error.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('There was a problem with your payment. Please try again.');
            
            const button = event.target;
            button.disabled = false;
            button.textContent = originalText;
        }
    }
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('submit-form');
    const loadingScreen = document.querySelector('.loading-screen');
    const resultDiv = document.getElementById('result');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const recaptchaResponse = grecaptcha.getResponse();
        if (!recaptchaResponse) {
            alert('Please complete the CAPTCHA');
            return;
        }

        loadingScreen.style.display = 'flex';
        resultDiv.style.display = 'none';

        let formData = new FormData(form);
        formData.append('g-recaptcha-response', recaptchaResponse);
        
        fetch('{{ url_for("submit") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            loadingScreen.style.display = 'none';
            
            if (data.error) {
                alert(data.error);
                if (data.require_login) {
                    window.location.href = '{{ url_for("login") }}';
                } else if (data.require_payment) {
                    const purchaseSection = document.querySelector('.purchase-credits');
                    if (purchaseSection) {
                        purchaseSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            } else {
                document.getElementById('story').textContent = data.story;
                document.getElementById('image').src = data.image;
                resultDiv.style.display = 'block';
                resultDiv.scrollIntoView({ behavior: 'smooth' });
            }
        })
        .catch(error => {
            loadingScreen.style.display = 'none';
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        })
        .finally(() => {
            grecaptcha.reset();
        });
    });
});
</script> 
{% endblock %}
